/**
 * @fileoverview added by tsickle
 * Generated from: cmds/extract.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { readFileSync, statSync } from 'fs';
import { sync } from 'glob';
import { basename, extname, posix, resolve } from 'path';
import { Diagnostics } from './common/diagnostics';
import { FileUtils } from './common/file_utils';
import { getExtension, getTranslationSerializer } from './common/util';
import { Extractor } from './extract/extractor';
/** @type {?} */
export var command = 'extract';
/** @type {?} */
export var describe = 'Extract translations from your ivy application';
/** @type {?} */
export var builder = {
    s: {
        alias: 'source',
        required: true,
        describe: 'A glob pattern indicating what files to search for translations, e.g. `./dist/**/*.js`. This can be absolute or relative to the current working directory.'
    },
    f: {
        alias: 'format',
        required: true,
        describe: 'The format of the translation files to generate.',
        choices: ['json', 'xlf', 'xmb', 'xlf2'],
        default: 'json'
    },
    o: {
        alias: 'outputPath',
        required: true,
        describe: 'A path to where the translation file will be written. This can be absolute or relative to the current working directory.'
    },
    l: {
        alias: ['locale', 'locales'],
        required: false,
        type: 'array',
        describe: 'The locale for the extracted file, "en" by default. If you use multiple locales (e.g. "en fr es"), a new file will be generated for each locale'
    }
};
/** @type {?} */
export var handler = (/**
 * @param {?} options
 * @return {?}
 */
function (options) {
    /** @type {?} */
    var diagnostics = new Diagnostics();
    extractTranslations({
        sourceGlob: (/** @type {?} */ (options['s'])),
        format: (/** @type {?} */ (options['f'])),
        outputPath: (/** @type {?} */ (options['o'])),
        locales: (/** @type {?} */ (options['l'])),
        diagnostics: diagnostics
    });
    diagnostics.logMessages();
    process.exit(diagnostics.hasErrors ? 1 : 0);
});
/**
 * @record
 */
export function ExtractTranslationsOptions() { }
if (false) {
    /** @type {?} */
    ExtractTranslationsOptions.prototype.sourceGlob;
    /** @type {?} */
    ExtractTranslationsOptions.prototype.format;
    /** @type {?} */
    ExtractTranslationsOptions.prototype.outputPath;
    /** @type {?|undefined} */
    ExtractTranslationsOptions.prototype.locales;
    /** @type {?} */
    ExtractTranslationsOptions.prototype.diagnostics;
}
/**
 * @param {?} __0
 * @return {?}
 */
export function extractTranslations(_a) {
    var source = _a.sourceGlob, format = _a.format, output = _a.outputPath, _b = _a.locales, locales = _b === void 0 ? ['en'] : _b, diagnostics = _a.diagnostics;
    console.log("Extracting translations from \"" + source + "\"");
    /** @type {?} */
    var filesToProcess = sync(resolve(source), {
        absolute: true,
        nodir: true
    });
    filesToProcess = FileUtils.dedup(filesToProcess, /\-es(5|2015)\./, '.');
    output = resolve(output);
    /** @type {?} */
    var generatedFiles = [];
    /** @type {?} */
    var isFile;
    try {
        /** @type {?} */
        var stat = statSync(output);
        isFile = stat.isFile();
    }
    catch (e) {
        isFile = !!extname(output);
    }
    if (isFile) {
        if (locales.length > 1) {
            diagnostics.error("Multiple locales detected (\"" + locales.join(',') + "\") but output \"" + output + "\" is not a directory");
            return;
        }
        /** @type {?} */
        var res = makeTranslationsFile(filesToProcess, posix.normalize(output), source, format, locales[0], diagnostics);
        if (res) {
            generatedFiles.push(res);
        }
    }
    else {
        filesToProcess.forEach((/**
         * @param {?} file
         * @return {?}
         */
        function (file) {
            locales.forEach((/**
             * @param {?} locale
             * @return {?}
             */
            function (locale) {
                /** @type {?} */
                var newFileName = posix.join(output, basename(file, '.js').replace(/-es(5|2015)/, '') +
                    '.' +
                    locale +
                    '.' +
                    getExtension(format));
                /** @type {?} */
                var res = makeTranslationsFile([file], newFileName, source, format, locale, diagnostics);
                if (res) {
                    generatedFiles.push(res);
                }
            }));
        }));
    }
    if (!generatedFiles.length) {
        diagnostics.error("No messages found. You should build the angular app without a language target for this command to work.");
        return;
    }
}
/**
 * @param {?} filesToProcess
 * @param {?} fileOutput
 * @param {?} source
 * @param {?} format
 * @param {?} locale
 * @param {?} diagnostics
 * @return {?}
 */
function makeTranslationsFile(filesToProcess, fileOutput, source, format, locale, diagnostics) {
    /** @type {?} */
    var extractor = new Extractor(diagnostics);
    filesToProcess.forEach((/**
     * @param {?} file
     * @return {?}
     */
    function (file) {
        /** @type {?} */
        var contents = readFileSync(file, 'utf8');
        extractor.extractMessages(contents);
    }));
    /** @type {?} */
    var serializer = getTranslationSerializer(format);
    if (extractor.messages.length > 0) {
        /** @type {?} */
        var translationFile = serializer.renderFile(extractor.messages, locale, false);
        FileUtils.writeFile(fileOutput, translationFile);
        console.log("  Generated file \"" + fileOutput + "\"");
        return fileOutput;
    }
    return null;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0cmFjdC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bsb2NsL2NsaS8iLCJzb3VyY2VzIjpbImNtZHMvZXh0cmFjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsUUFBUSxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQzVDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDNUIsT0FBTyxFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN6RCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2hELE9BQU8sRUFDTCxZQUFZLEVBQ1osd0JBQXdCLEVBRXpCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7QUFFaEQsTUFBTSxLQUFPLE9BQU8sR0FBRyxTQUFTOztBQUNoQyxNQUFNLEtBQU8sUUFBUSxHQUFHLGdEQUFnRDs7QUFDeEUsTUFBTSxLQUFPLE9BQU8sR0FBRztJQUNyQixDQUFDLEVBQUU7UUFDRCxLQUFLLEVBQUUsUUFBUTtRQUNmLFFBQVEsRUFBRSxJQUFJO1FBQ2QsUUFBUSxFQUNOLDRKQUE0SjtLQUMvSjtJQUNELENBQUMsRUFBRTtRQUNELEtBQUssRUFBRSxRQUFRO1FBQ2YsUUFBUSxFQUFFLElBQUk7UUFDZCxRQUFRLEVBQUUsa0RBQWtEO1FBQzVELE9BQU8sRUFBRSxDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQztRQUN2QyxPQUFPLEVBQUUsTUFBTTtLQUNoQjtJQUNELENBQUMsRUFBRTtRQUNELEtBQUssRUFBRSxZQUFZO1FBQ25CLFFBQVEsRUFBRSxJQUFJO1FBQ2QsUUFBUSxFQUNOLDBIQUEwSDtLQUM3SDtJQUNELENB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QUMsR0FBRyxDQUFDLHdCQUFxQixVQUFVLE9BQUcsQ0FBQyxDQUFDO1FBQ2hELE9BQU8sVUFBVSxDQUFDO0tBQ25CO0lBQ0QsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcmVhZEZpbGVTeW5jLCBzdGF0U3luYyB9IGZyb20gJ2ZzJztcclxuaW1wb3J0IHsgc3luYyB9IGZyb20gJ2dsb2InO1xyXG5pbXBvcnQgeyBiYXNlbmFtZSwgZXh0bmFtZSwgcG9zaXgsIHJlc29sdmUgfSBmcm9tICdwYXRoJztcclxuaW1wb3J0IHsgRGlhZ25vc3RpY3MgfSBmcm9tICcuL2NvbW1vbi9kaWFnbm9zdGljcyc7XHJcbmltcG9ydCB7IEZpbGVVdGlscyB9IGZyb20gJy4vY29tbW9uL2ZpbGVfdXRpbHMnO1xyXG5pbXBvcnQge1xyXG4gIGdldEV4dGVuc2lvbixcclxuICBnZXRUcmFuc2xhdGlvblNlcmlhbGl6ZXIsXHJcbiAgVHJhbnNsYXRpb25Gb3JtYXRcclxufSBmcm9tICcuL2NvbW1vbi91dGlsJztcclxuaW1wb3J0IHsgRXh0cmFjdG9yIH0gZnJvbSAnLi9leHRyYWN0L2V4dHJhY3Rvcic7XHJcblxyXG5leHBvcnQgY29uc3QgY29tbWFuZCA9ICdleHRyYWN0JztcclxuZXhwb3J0IGNvbnN0IGRlc2NyaWJlID0gJ0V4dHJhY3QgdHJhbnNsYXRpb25zIGZyb20geW91ciBpdnkgYXBwbGljYXRpb24nO1xyXG5leHBvcnQgY29uc3QgYnVpbGRlciA9IHtcclxuICBzOiB7XHJcbiAgICBhbGlhczogJ3NvdXJjZScsXHJcbiAgICByZXF1aXJlZDogdHJ1ZSxcclxuICAgIGRlc2NyaWJlOlxyXG4gICAgICAnQSBnbG9iIHBhdHRlcm4gaW5kaWNhdGluZyB3aGF0IGZpbGVzIHRvIHNlYXJjaCBmb3IgdHJhbnNsYXRpb25zLCBlLmcuIGAuL2Rpc3QvKiovKi5qc2AuIFRoaXMgY2FuIGJlIGFic29sdXRlIG9yIHJlbGF0aXZlIHRvIHRoZSBjdXJyZW50IHdvcmtpbmcgZGlyZWN0b3J5LidcclxuICB9LFxyXG4gIGY6IHtcclxuICAgIGFsaWFzOiAnZm9ybWF0JyxcclxuICAgIHJlcXVpcmVkOiB0cnVlLFxyXG4gICAgZGVzY3JpYmU6ICdUaGUgZm9ybWF0IG9mIHRoZSB0cmFuc2xhdGlvbiBmaWxlcyB0byBnZW5lcmF0ZS4nLFxyXG4gICAgY2hvaWNlczogWydqc29uJywgJ3hsZicsICd4bWInLCAneGxmMiddLFxyXG4gICAgZGVmYXVsdDogJ2pzb24nXHJcbiAgfSxcclxuICBvOiB7XHJcbiAgICBhbGlhczogJ291dHB1dFBhdGgnLFxyXG4gICAgcmVxdWlyZWQ6IHRydWUsXHJcbiAgICBkZXNjcmliZTpcclxuICAgICAgJ0EgcGF0aCB0byB3aGVyZSB0aGUgdHJhbnNsYXRpb24gZmlsZSB3aWxsIGJlIHdyaXR0ZW4uIFRoaXMgY2FuIGJlIGFic29sdXRlIG9yIHJlbGF0aXZlIHRvIHRoZSBjdXJyZW50IHdvcmtpbmcgZGlyZWN0b3J5LidcclxuICB9LFxyXG4gIGw6IHtcclxuICAgIGFsaWFzOiBbJ2xvY2FsZScsICdsb2NhbGVzJ10sXHJcbiAgICByZXF1aXJlZDogZmFsc2UsXHJcbiAgICB0eXBlOiAnYXJyYXknLFxyXG4gICAgZGVzY3JpYmU6XHJcbiAgICAgICdUaGUgbG9jYWxlIGZvciB0aGUgZXh0cmFjdGVkIGZpbGUsIFwiZW5cIiBieSBkZWZhdWx0LiBJZiB5b3UgdXNlIG11bHRpcGxlIGxvY2FsZXMgKGUuZy4gXCJlbiBmciBlc1wiKSwgYSBuZXcgZmlsZSB3aWxsIGJlIGdlbmVyYXRlZCBmb3IgZWFjaCBsb2NhbGUnXHJcbiAgfVxyXG59O1xyXG5cclxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBmdW5jdGlvbihvcHRpb25zKSB7XHJcbiAgY29uc3QgZGlhZ25vc3RpY3MgPSBuZXcgRGlhZ25vc3RpY3MoKTtcclxuICBleHRyYWN0VHJhbnNsYXRpb25zKHtcclxuICAgIHNvdXJjZUdsb2I6IG9wdGlvbnNbJ3MnXSBhcyBzdHJpbmcsXHJcbiAgICBmb3JtYXQ6IG9wdGlvbnNbJ2YnXSBhcyBUcmFuc2xhdGlvbkZvcm1hdCxcclxuICAgIG91dHB1dFBhdGg6IG9wdGlvbnNbJ28nXSBhcyBzdHJpbmcsXHJcbiAgICBsb2NhbGVzOiBvcHRpb25zWydsJ10gYXMgc3RyaW5nW10sXHJcbiAgICBkaWFnbm9zdGljc1xyXG4gIH0pO1xyXG4gIGRpYWdub3N0aWNzLmxvZ01lc3NhZ2VzKCk7XHJcbiAgcHJvY2Vzcy5leGl0KGRpYWdub3N0aWNzLmhhc0Vycm9ycyA/IDEgOiAwKTtcclxufTtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRXh0cmFjdFRyYW5zbGF0aW9uc09wdGlvbnMge1xyXG4gIHNvdXJjZUdsb2I6IHN0cmluZztcclxuICBmb3JtYXQ6IFRyYW5zbGF0aW9uRm9ybWF0O1xyXG4gIG91dHB1dFBhdGg6IHN0cmluZztcclxuICBsb2NhbGVzPzogc3RyaW5nW107XHJcbiAgZGlhZ25vc3RpY3M6IERpYWdub3N0aWNzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXh0cmFjdFRyYW5zbGF0aW9ucyh7XHJcbiAgc291cmNlR2xvYjogc291cmNlLFxyXG4gIGZvcm1hdCxcclxuICBvdXRwdXRQYXRoOiBvdXRwdXQsXHJcbiAgbG9jYWxlcyA9IFsnZW4nXSxcclxuICBkaWFnbm9zdGljc1xyXG59OiBFeHRyYWN0VHJhbnNsYXRpb25zT3B0aW9ucykge1xyXG4gIGNvbnNvbGUubG9nKGBFeHRyYWN0aW5nIHRyYW5zbGF0aW9ucyBmcm9tIFwiJHtzb3VyY2V9XCJgKTtcclxuICBsZXQgZmlsZXNUb1Byb2Nlc3MgPSBzeW5jKHJlc29sdmUoc291cmNlKSwge1xyXG4gICAgYWJzb2x1dGU6IHRydWUsXHJcbiAgICBub2RpcjogdHJ1ZVxyXG4gIH0pO1xyXG4gIGZpbGVzVG9Qcm9jZXNzID0gRmlsZVV0aWxzLmRlZHVwKGZpbGVzVG9Qcm9jZXNzLCAvXFwtZXMoNXwyMDE1KVxcLi8sICcuJyk7XHJcbiAgb3V0cHV0ID0gcmVzb2x2ZShvdXRwdXQpO1xyXG4gIGNvbnN0IGdlbmVyYXRlZEZpbGVzOiBzdHJpbmdbXSA9IFtdO1xyXG4gIGxldCBpc0ZpbGU6IGJvb2xlYW47XHJcbiAgdHJ5IHtcclxuICAgIGNvbnN0IHN0YXQgPSBzdGF0U3luYyhvdXRwdXQpO1xyXG4gICAgaXNGaWxlID0gc3RhdC5pc0ZpbGUoKTtcclxuICB9IGNhdGNoIChlKSB7XHJcbiAgICBpc0ZpbGUgPSAhIWV4dG5hbWUob3V0cHV0KTtcclxuICB9XHJcbiAgaWYgKGlzRmlsZSkge1xyXG4gICAgaWYgKGxvY2FsZXMubGVuZ3RoID4gMSkge1xyXG4gICAgICBkaWFnbm9zdGljcy5lcnJvcihcclxuICAgICAgICBgTXVsdGlwbGUgbG9jYWxlcyBkZXRlY3RlZCAoXCIke2xvY2FsZXMuam9pbihcclxuICAgICAgICAgICcsJ1xyXG4gICAgICAgICl9XCIpIGJ1dCBvdXRwdXQgXCIke291dHB1dH1cIiBpcyBub3QgYSBkaXJlY3RvcnlgXHJcbiAgICAgICk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IHJlcyA9IG1ha2VUcmFuc2xhdGlvbnNGaWxlKFxyXG4gICAgICBmaWxlc1RvUHJvY2VzcyxcclxuICAgICAgcG9zaXgubm9ybWFsaXplKG91dHB1dCksXHJcbiAgICAgIHNvdXJjZSxcclxuICAgICAgZm9ybWF0LFxyXG4gICAgICBsb2NhbGVzWzBdLFxyXG4gICAgICBkaWFnbm9zdGljc1xyXG4gICAgKTtcclxuICAgIGlmIChyZXMpIHtcclxuICAgICAgZ2VuZXJhdGVkRmlsZXMucHVzaChyZXMpO1xyXG4gICAgfVxyXG4gIH0gZWxzZSB7XHJcbiAgICBmaWxlc1RvUHJvY2Vzcy5mb3JFYWNoKGZpbGUgPT4ge1xyXG4gICAgICBsb2NhbGVzLmZvckVhY2gobG9jYWxlID0+IHtcclxuICAgICAgICBjb25zdCBuZXdGaWxlTmFtZSA9IHBvc2l4LmpvaW4oXHJcbiAgICAgICAgICBvdXRwdXQsXHJcbiAgICAgICAgICBiYXNlbmFtZShmaWxlLCAnLmpzJykucmVwbGFjZSgvLWVzKDV8MjAxNSkvLCAnJykgK1xyXG4gICAgICAgICAgICAnLicgK1xyXG4gICAgICAgICAgICBsb2NhbGUgK1xyXG4gICAgICAgICAgICAnLicgK1xyXG4gICAgICAgICAgICBnZXRFeHRlbnNpb24oZm9ybWF0KVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgY29uc3QgcmVzID0gbWFrZVRyYW5zbGF0aW9uc0ZpbGUoXHJcbiAgICAgICAgICBbZmlsZV0sXHJcbiAgICAgICAgICBuZXdGaWxlTmFtZSxcclxuICAgICAgICAgIHNvdXJjZSxcclxuICAgICAgICAgIGZvcm1hdCxcclxuICAgICAgICAgIGxvY2FsZSxcclxuICAgICAgICAgIGRpYWdub3N0aWNzXHJcbiAgICAgICAgKTtcclxuICAgICAgICBpZiAocmVzKSB7XHJcbiAgICAgICAgICBnZW5lcmF0ZWRGaWxlcy5wdXNoKHJlcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBpZiAoIWdlbmVyYXRlZEZpbGVzLmxlbmd0aCkge1xyXG4gICAgZGlhZ25vc3RpY3MuZXJyb3IoXHJcbiAgICAgIGBObyBtZXNzYWdlcyBmb3VuZC4gWW91IHNob3VsZCBidWlsZCB0aGUgYW5ndWxhciBhcHAgd2l0aG91dCBhIGxhbmd1YWdlIHRhcmdldCBmb3IgdGhpcyBjb21tYW5kIHRvIHdvcmsuYFxyXG4gICAgKTtcclxuICAgIHJldHVybjtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1ha2VUcmFuc2xhdGlvbnNGaWxlKFxyXG4gIGZpbGVzVG9Qcm9jZXNzOiBzdHJpbmdbXSxcclxuICBmaWxlT3V0cHV0OiBzdHJpbmcsXHJcbiAgc291cmNlOiBzdHJpbmcsXHJcbiAgZm9ybWF0OiBUcmFuc2xhdGlvbkZvcm1hdCxcclxuICBsb2NhbGU6IHN0cmluZyxcclxuICBkaWFnbm9zdGljczogRGlhZ25vc3RpY3NcclxuKTogc3RyaW5nIHwgbnVsbCB7XHJcbiAgY29uc3QgZXh0cmFjdG9yID0gbmV3IEV4dHJhY3RvcihkaWFnbm9zdGljcyk7XHJcbiAgZmlsZXNUb1Byb2Nlc3MuZm9yRWFjaChmaWxlID0+IHtcclxuICAgIGNvbnN0IGNvbnRlbnRzID0gcmVhZEZpbGVTeW5jKGZpbGUsICd1dGY4Jyk7XHJcbiAgICBleHRyYWN0b3IuZXh0cmFjdE1lc3NhZ2VzKGNvbnRlbnRzKTtcclxuICB9KTtcclxuXHJcbiAgY29uc3Qgc2VyaWFsaXplciA9IGdldFRyYW5zbGF0aW9uU2VyaWFsaXplcihmb3JtYXQpO1xyXG4gIGlmIChleHRyYWN0b3IubWVzc2FnZXMubGVuZ3RoID4gMCkge1xyXG4gICAgY29uc3QgdHJhbnNsYXRpb25GaWxlID0gc2VyaWFsaXplci5yZW5kZXJGaWxlKFxyXG4gICAgICBleHRyYWN0b3IubWVzc2FnZXMsXHJcbiAgICAgIGxvY2FsZSxcclxuICAgICAgZmFsc2VcclxuICAgICk7XHJcbiAgICBGaWxlVXRpbHMud3JpdGVGaWxlKGZpbGVPdXRwdXQsIHRyYW5zbGF0aW9uRmlsZSk7XHJcbiAgICBjb25zb2xlLmxvZyhgICBHZW5lcmF0ZWQgZmlsZSBcIiR7ZmlsZU91dHB1dH1cImApO1xyXG4gICAgcmV0dXJuIGZpbGVPdXRwdXQ7XHJcbiAgfVxyXG4gIHJldHVybiBudWxsO1xyXG59XHJcbiJdfQ==