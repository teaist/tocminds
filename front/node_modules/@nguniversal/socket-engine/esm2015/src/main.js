/**
 * @fileoverview added by tsickle
 * Generated from: modules/socket-engine/src/main.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { __awaiter } from "tslib";
import { ÉµCommonEngine as CommonEngine } from '@nguniversal/common/engine';
import * as net from 'net';
/**
 * @record
 */
export function SocketEngineServer() { }
if (false) {
    /** @type {?} */
    SocketEngineServer.prototype.close;
}
/**
 * @record
 */
export function SocketEngineRenderOptions() { }
if (false) {
    /** @type {?} */
    SocketEngineRenderOptions.prototype.id;
}
/**
 * @record
 */
export function SocketEngineResponse() { }
if (false) {
    /** @type {?} */
    SocketEngineResponse.prototype.id;
    /** @type {?} */
    SocketEngineResponse.prototype.html;
    /** @type {?|undefined} */
    SocketEngineResponse.prototype.error;
}
/**
 * @param {?} moduleOrFactory
 * @param {?=} providers
 * @param {?=} host
 * @param {?=} port
 * @return {?}
 * @this {*}
 */
export function startSocketEngine(moduleOrFactory, providers = [], host = 'localhost', port = 9090) {
    return new Promise((/**
     * @param {?} resolve
     * @param {?} _reject
     * @return {?}
     */
    (resolve, _reject) => {
        /** @type {?} */
        const engine = new CommonEngine(moduleOrFactory, providers);
        /** @type {?} */
        const server = net.createServer((/**
         * @param {?} socket
         * @return {?}
         */
        socket => {
            socket.on('data', (/**
             * @param {?} buff
             * @return {?}
             */
            (buff) => __awaiter(this, void 0, void 0, function* () {
                /** @type {?} */
                const message = buff.toString();
                /** @type {?} */
                const renderOptions = (/** @type {?} */ (JSON.parse(message)));
                try {
                    /** @type {?} */
                    const html = yield engine.render(renderOptions);
                    socket.write(JSON.stringify((/** @type {?} */ ({ html, id: renderOptions.id }))));
                }
                catch (error) {
                    // send the error down to the client then rethrow it
                    socket.write(JSON.stringify((/** @type {?} */ ({
                        html: null,
                        id: renderOptions.id,
                        error: error.toString(),
                    }))));
                }
            })));
        }));
        server.listen(port, host);
        resolve({ close: (/**
             * @return {?}
             */
            () => server.close()) });
    }));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL21vZHVsZXMvc29ja2V0LWVuZ2luZS9zcmMvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFRQSxPQUFPLEVBQUUsYUFBYSxJQUFJLFlBQVksRUFDSCxNQUFNLDRCQUE0QixDQUFDO0FBQ3RFLE9BQU8sS0FBSyxHQUFHLE1BQU0sS0FBSyxDQUFDOzs7O0FBRTNCLHdDQUVDOzs7SUFEQyxtQ0FBa0I7Ozs7O0FBR3BCLCtDQUVDOzs7SUFEQyx1Q0FBVzs7Ozs7QUFHYiwwQ0FJQzs7O0lBSEMsa0NBQVc7O0lBQ1gsb0NBQWtCOztJQUNsQixxQ0FBYzs7Ozs7Ozs7OztBQUdoQixNQUFNLFVBQVUsaUJBQWlCLENBQy9CLGVBQStDLEVBQy9DLFlBQThCLEVBQUUsRUFDaEMsSUFBSSxHQUFHLFdBQVcsRUFDbEIsSUFBSSxHQUFHLElBQUk7SUFFWCxPQUFPLElBQUksT0FBTzs7Ozs7SUFBQyxDQUFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRTs7Y0FDaEMsTUFBTSxHQUFHLElBQUksWUFBWSxDQUFDLGVBQWUsRUFBRSxTQUFTLENBQUM7O2NBRXJELE1BQU0sR0FBRyxHQUFHLENBQUMsWUFBWTs7OztRQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3ZDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTTs7OztZQUFFLENBQU0sSUFBSSxFQUFDLEVBQUU7O3NCQUN2QixPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRTs7c0JBQ3pCLGFBQWEsR0FBRyxtQkFBQSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUE2QjtnQkFDdEUsSUFBSTs7MEJBQ0ksSUFBSSxHQUFHLE1BQU0sTUFBTSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7b0JBQy9DLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxtQkFBQSxFQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsYUFBYSxDQUFDLEVBQUUsRUFBQyxFQUF3QixDQUFDLENBQUMsQ0FBQztpQkFDcEY7Z0JBQUMsT0FBTyxLQUFLLEVBQUU7b0JBQ2Qsb0RBQW9EO29CQUNwRCxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQUE7d0JBQzFCLElBQUksRUFBRSxJQUFJO3dCQUNWLEVBQUUsRUFBRSxhQUFhLENBQUMsRUFBRTt3QkFDcEIsS0FBSyxFQUFFLEtBQUssQ0FBQyxRQUFRLEVBQUU7cUJBQ3hCLEVBQXdCLENBQUMsQ0FBQyxDQUFDO2lCQUM3QjtZQUNILENBQUMsQ0FBQSxFQUFDLENBQUM7UUFDTCxDQUFDLEVBQUM7UUFFRixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMxQixPQUFPLENBQUMsRUFBQyxLQUFLOzs7WUFBRSxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUEsRUFBQyxDQUFDLENBQUM7SUFDekMsQ0FBQyxFQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5pbXBvcnQgeyBOZ01vZHVsZUZhY3RvcnksIFN0YXRpY1Byb3ZpZGVyLCBUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyDJtUNvbW1vbkVuZ2luZSBhcyBDb21tb25FbmdpbmUsXG4gIMm1UmVuZGVyT3B0aW9ucyBhcyBSZW5kZXJPcHRpb25zIH0gZnJvbSAnQG5ndW5pdmVyc2FsL2NvbW1vbi9lbmdpbmUnO1xuaW1wb3J0ICogYXMgbmV0IGZyb20gJ25ldCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU29ja2V0RW5naW5lU2VydmVyIHtcbiAgY2xvc2U6ICgpID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU29ja2V0RW5naW5lUmVuZGVyT3B0aW9ucyBleHRlbmRzIFJlbmRlck9wdGlvbnMge1xuICBpZDogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNvY2tldEVuZ2luZVJlc3BvbnNlIHtcbiAgaWQ6IG51bWJlcjtcbiAgaHRtbDogc3RyaW5nfG51bGw7XG4gIGVycm9yPzogRXJyb3I7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdGFydFNvY2tldEVuZ2luZShcbiAgbW9kdWxlT3JGYWN0b3J5OiBUeXBlPHt9PiB8IE5nTW9kdWxlRmFjdG9yeTx7fT4sXG4gIHByb3ZpZGVyczogU3RhdGljUHJvdmlkZXJbXSA9IFtdLFxuICBob3N0ID0gJ2xvY2FsaG9zdCcsXG4gIHBvcnQgPSA5MDkwXG4pOiBQcm9taXNlPFNvY2tldEVuZ2luZVNlcnZlcj4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIF9yZWplY3QpID0+IHtcbiAgICBjb25zdCBlbmdpbmUgPSBuZXcgQ29tbW9uRW5naW5lKG1vZHVsZU9yRmFjdG9yeSwgcHJvdmlkZXJzKTtcblxuICAgIGNvbnN0IHNlcnZlciA9IG5ldC5jcmVhdGVTZXJ2ZXIoc29ja2V0ID0+IHtcbiAgICAgIHNvY2tldC5vbignZGF0YScsIGFzeW5jIGJ1ZmYgPT4ge1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gYnVmZi50b1N0cmluZygpO1xuICAgICAgICBjb25zdCByZW5kZXJPcHRpb25zID0gSlNPTi5wYXJzZShtZXNzYWdlKSBhcyBTb2NrZXRFbmdpbmVSZW5kZXJPcHRpb25zO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IGh0bWwgPSBhd2FpdCBlbmdpbmUucmVuZGVyKHJlbmRlck9wdGlvbnMpO1xuICAgICAgICAgIHNvY2tldC53cml0ZShKU09OLnN0cmluZ2lmeSh7aHRtbCwgaWQ6IHJlbmRlck9wdGlvbnMuaWR9IGFzIFNvY2tldEVuZ2luZVJlc3BvbnNlKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgLy8gc2VuZCB0aGUgZXJyb3IgZG93biB0byB0aGUgY2xpZW50IHRoZW4gcmV0aHJvdyBpdFxuICAgICAgICAgIHNvY2tldC53cml0ZShKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICBodG1sOiBudWxsLFxuICAgICAgICAgICAgaWQ6IHJlbmRlck9wdGlvbnMuaWQsXG4gICAgICAgICAgICBlcnJvcjogZXJyb3IudG9TdHJpbmcoKSxcbiAgICAgICAgICB9IGFzIFNvY2tldEVuZ2luZVJlc3BvbnNlKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgc2VydmVyLmxpc3Rlbihwb3J0LCBob3N0KTtcbiAgICByZXNvbHZlKHtjbG9zZTogKCkgPT4gc2VydmVyLmNsb3NlKCl9KTtcbiAgfSk7XG59XG5cbiJdfQ==